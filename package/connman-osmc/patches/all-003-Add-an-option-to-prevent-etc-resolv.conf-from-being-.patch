From e0bb7074427bedcc606715242a1861b92fb13a89 Mon Sep 17 00:00:00 2001
From: Sam Nazarko <email@samnazarko.co.uk>
Date: Thu, 3 Sep 2015 16:58:42 +0100
Subject: [PATCH] Add an option to prevent /etc/resolv.conf from being modified

Signed-off-by: Sam Nazarko <email@samnazarko.co.uk>
---
 src/connman.h  |  2 +-
 src/main.c     |  6 +++++-
 src/resolver.c | 10 +++++++++-
 3 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/src/connman.h b/src/connman.h
index e849ed8..d5d040a 100644
--- a/src/connman.h
+++ b/src/connman.h
@@ -246,7 +246,7 @@ int __connman_inet_get_address_netmask(int ifindex,
 
 #include <connman/resolver.h>
 
-int __connman_resolver_init(gboolean dnsproxy);
+int __connman_resolver_init(gboolean dnsproxy, gboolean allowresolvmodify);
 void __connman_resolver_cleanup(void);
 void __connman_resolver_append_fallback_nameservers(void);
 int __connman_resolvfile_append(int index, const char *domain, const char *server);
diff --git a/src/main.c b/src/main.c
index f44a2ed..8b9230b 100644
--- a/src/main.c
+++ b/src/main.c
@@ -470,6 +470,7 @@ static gchar *option_noplugin = NULL;
 static gchar *option_wifi = NULL;
 static gboolean option_detach = TRUE;
 static gboolean option_dnsproxy = TRUE;
+static gboolean option_allowresolvmodify = TRUE;
 static gboolean option_backtrace = TRUE;
 static gboolean option_version = FALSE;
 
@@ -507,6 +508,9 @@ static GOptionEntry options[] = {
 	{ "nodnsproxy", 'r', G_OPTION_FLAG_REVERSE,
 				G_OPTION_ARG_NONE, &option_dnsproxy,
 				"Don't enable DNS Proxy" },
+	{ "noresolvmodify", 's', G_OPTION_FLAG_REVERSE,
+				G_OPTION_ARG_NONE, &option_allowresolvmodify,
+				"Don't allow resolv.conf changes. Useful if ignoring the primary interface" },
 	{ "nobacktrace", 0, G_OPTION_FLAG_REVERSE,
 				G_OPTION_ARG_NONE, &option_backtrace,
 				"Don't print out backtrace information" },
@@ -689,7 +693,7 @@ int main(int argc, char *argv[])
 
 	__connman_plugin_init(option_plugin, option_noplugin);
 
-	__connman_resolver_init(option_dnsproxy);
+	__connman_resolver_init(option_dnsproxy, option_allowresolvmodify);
 	__connman_rtnl_start();
 	__connman_dhcp_init();
 	__connman_dhcpv6_init();
diff --git a/src/resolver.c b/src/resolver.c
index fbe4be7..9d536fd 100644
--- a/src/resolver.c
+++ b/src/resolver.c
@@ -58,6 +58,7 @@ struct entry_data {
 
 static GSList *entry_list = NULL;
 static bool dnsproxy_enabled = false;
+static bool allowresolvmodify_enabled = true;
 
 struct resolvfile_entry {
 	int index;
@@ -92,6 +93,9 @@ static int resolvfile_export(void)
 	unsigned int count;
 	mode_t old_umask;
 
+	if (! allowresolvmodify_enabled)
+		return 0;
+
 	content = g_string_new("# Generated by Connection Manager\n");
 
 	/*
@@ -652,11 +656,15 @@ static void free_resolvfile(gpointer data)
 	g_free(entry);
 }
 
-int __connman_resolver_init(gboolean dnsproxy)
+int __connman_resolver_init(gboolean dnsproxy, gboolean allowresolvmodify)
 {
 	int i;
 	char **ns;
 
+	DBG("allowresolvmodify %d", allowresolvmodify);
+
+	allowresolvmodify_enabled = allowresolvmodify;
+
 	DBG("dnsproxy %d", dnsproxy);
 
 	if (!dnsproxy)
-- 
2.1.4

